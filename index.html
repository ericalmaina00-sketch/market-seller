<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #2c3e50; color: #333; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        /* Upload Section */
        .form-container { background: white; padding: 30px; border-radius: 8px; width: 100%; max-width: 450px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); margin-bottom: 30px; }
        h2 { text-align: center; margin-top: 0; color: #2c3e50; }
        input { width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button#saveBtn { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        button#saveBtn:hover { background: #219150; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        #status { margin-top: 15px; font-weight: bold; text-align: center; min-height: 20px; }

        /* Inventory List Section */
        .inventory-section { width: 100%; max-width: 600px; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; color: white; }
        .inventory-item { background: white; color: #333; padding: 10px; margin-bottom: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .item-info { display: flex; align-items: center; gap: 10px; }
        .thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; }
        .delete-btn { background: #e74c3c; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; margin-left: 10px; }
        .delete-btn:hover { background: #c0392b; }
    </style>
</head>
<body>

    <div class="form-container">
        <h2>Upload Product</h2>
        <input type="text" id="pName" placeholder="Product Name">
        <input type="number" id="pPrice" placeholder="Price (KES)">
        <input type="text" id="pPhone" placeholder="Phone (e.g. 0712 345 678)" >
        <input type="file" id="pImage" accept="image/*">
        
        <button id="saveBtn">Upload to Market</button>
        <div id="status"></div>
    </div>

    <div class="inventory-section">
        <h3 style="text-align: center; margin-top: 0;">Manage Stock</h3>
        <div id="inventoryList">Loading stock...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // --- YOUR CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDgfRx4o6f_uMmyHi27quwWTDNX1lDuY2s",
            authDomain: "marketplace-9b716.firebaseapp.com",
            databaseURL: "https://marketplace-9b716-default-rtdb.firebaseio.com",
            projectId: "marketplace-9b716",
            storageBucket: "marketplace-9b716.firebasestorage.app",
            messagingSenderId: "1046620427054",
            appId: "1:1046620427054:web:480d3aa91a792fa34720bf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- 1. UPLOAD LOGIC ---
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxWidth = 500; 
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    }
                }
            });
        }

        document.getElementById('saveBtn').addEventListener('click', async () => {
            const btn = document.getElementById('saveBtn');
            const status = document.getElementById('status');
            const fileInput = document.getElementById('pImage');
            
            if(fileInput.files.length === 0) return alert("Select an image!");

            btn.disabled = true;
            btn.innerText = "Uploading...";
            status.innerText = "";

            try {
                const base64 = await compressImage(fileInput.files[0]);
                
                const productListRef = ref(db, 'products');
                const newProductRef = push(productListRef);
                await set(newProductRef, {
                    name: document.getElementById('pName').value,
                    price: document.getElementById('pPrice').value,
                    phone: document.getElementById('pPhone').value,
                    image: base64,
                    createdAt: Date.now()
                });

                status.innerText = "âœ… Uploaded!";
                status.style.color = "green";
                
                document.getElementById('pName').value = '';
                document.getElementById('pPrice').value = '';
                document.getElementById('pImage').value = '';

                setTimeout(() => { status.innerText = ""; btn.disabled = false; btn.innerText = "Upload to Market"; }, 2000);

            } catch (e) {
                console.error(e);
                status.innerText = "Error: " + e.message;
                status.style.color = "red";
                btn.disabled = false;
            }
        });

        // --- 2. DELETE / MANAGE STOCK LOGIC ---
        const inventoryList = document.getElementById('inventoryList');
        const productsRef = ref(db, 'products');

        onValue(productsRef, (snapshot) => {
            inventoryList.innerHTML = "";
            const data = snapshot.val();

            if (!data) {
                inventoryList.innerHTML = "<p style='text-align:center;'>No items in stock.</p>";
                return;
            }

            // Loop through keys to keep track of ID
            Object.keys(data).reverse().forEach(key => {
                const item = data[key];
                
                // Create HTML for list item
                const div = document.createElement('div');
                div.className = 'inventory-item';
                div.innerHTML = `
                    <div class="item-info">
                        <img src="${item.image}" class="thumb">
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>KES ${item.price}</small>
                        </div>
                    </div>
                    <button class="delete-btn" id="btn-${key}">Delete</button>
                `;

                inventoryList.appendChild(div);

                // Add Click Event for Delete Button
                document.getElementById(`btn-${key}`).addEventListener('click', () => {
                    if(confirm(`Are you sure you want to delete "${item.name}"?`)) {
                        const itemRef = ref(db, 'products/' + key);
                        remove(itemRef)
                            .then(() => alert("Item removed!"))
                            .catch((error) => alert("Error removing: " + error.message));
                    }
                });
            });
        });

    </script>
</body>

</html>
